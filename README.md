# Madrid Cita Previa utilities

## What is this?

This is just a set of utilities (library, cli, and data generators), for
querying availability of on-site appointments in Madrid's town offices for
various procedures. It basically queries the page https://www.madrid.es/citaprevia.

This tool is specifically developed for querying public data in such page, like
appointment availability, but it don't (and it won't), support operations that
requires authentication or introducing your ID (such as actually getting an
appointment).

This repository have the following crates:
 - `madrid-cita-previa`: The core library, that enables querying data.

 - `madrid-cita-previa-datagen`: Allows to download a JSON with the model of all
   the offices and procedures available in the page.

 - `madrid-cita-previa-data`: Crate that is automatically generated based on the
   JSON generated by the `datagen` crate, and exposes all the available offices
   and procedures in the page.

 - `madrid-cita-previa-cli`: Crate that exposes the functionality of the core
   library as a CLI.

## Building

The CLI uses statically generated data generated by the data crate to work.
Therefore, it is required to run the data generation at least once before
building the CLI:

```rust
mkdir -p data
cargo run --release --bin madrid-cita-previa-datagen -- -o "data/model.json"
```

This command will download the data of all the offices and procedures available
in the page and store into the `data/model.json` file, which is where the `data`
crate expects to have it. This will download a lot of data from offices you may
not be interested on. In such case, you may request the data generator to
download data from just a subset of offices, for example:

```rust
cargo run --release --bin madrid-cita-previa-datagen -- \
  --filter-group "LINEA MADRID" \
  -o "data/model.json"
```

Once you've generated the data gen, you may build all the crates normally with:

```rust
cargo build --release
```

## CLI Examples

Fetching the office with the earliest appointment available:

```rust
cargo run --release --bin madrid-cita-previa-cli -- fetch-closest-appointment-office --procedure-id 321
```

(You may check all the procedure codes available with the `list-procedures`
subcommand)

Fetch the appointments available for all the offices that has a specific
procedure available:

```rust
cargo run --release  --bin madrid-cita-previa-cli -- fetch-procedure-appointments --procedure-id 321
```

Fetch the appointments available for all the offices that has a specific
procedure available, including information about the time of each slot available for each day:

```rust
cargo run --release  --bin madrid-cita-previa-cli -- fetch-procedure-appointments --procedure-id 321 --slots
```
